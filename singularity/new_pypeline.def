Bootstrap: docker

From: continuumio/miniconda3

%files
    new_pypeline_environment.yml /opt/pypeline.yml

%post
    export ENV_NAME=`head -n 1 /opt/pypeline.yml | cut -f 2 -d ' '`
    echo "export ENV_NAME=\"${ENV_NAME}\"" >> $SINGULARITY_ENVIRONMENT
    
    /opt/conda/bin/conda env create -f /opt/pypeline.yml

    /opt/conda/envs/$ENV_NAME/bin/pip install pycsou --no-deps
    /opt/conda/envs/$ENV_NAME/bin/pip install pyFFS --no-deps

    git clone https://github.com/imagingofthings/ImoT_tools.git
    cd ImoT_tools
    git checkout dev #641bf029498b505d6026566cd67b492f72af50e2
    /opt/conda/envs/$ENV_NAME/bin/pip install --no-deps .
    cd ..

%runscript
    exec /opt/conda/envs/${ENV_NAME}/bin/"$@"
    
%test
    echo ENV_NAME = $ENV_NAME
    echo $PATH
    which conda
    which python
    python -V
    which pip

%labels
    Author E.Orliac, SCITAS, EPFL
    Version v0.0.1
    
%help
    This is a container to run `pypeline`.
    
